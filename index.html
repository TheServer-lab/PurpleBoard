<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Purple Board — Shared (Worker reader)</title>
<style>
:root{--bg:#120018;--panel:#241033;--accent:#a86ff9;--muted:#cdb6ff;--text:#efe6ff}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;background:linear-gradient(180deg,var(--bg),#1b0228);color:var(--text)}
header{padding:12px;background:linear-gradient(90deg,#1b002b,#2b003f);border-bottom:1px solid rgba(255,255,255,0.04)}
.container{max-width:980px;margin:18px auto;padding:12px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.005));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);margin-bottom:12px}
.small{font-size:13px;color:var(--muted)}
.post{padding:8px;border-radius:8px;background:#0f0720;border:1px solid #36194f;margin-top:6px}
.thread-list{display:flex;flex-direction:column;gap:10px}
.thumb{max-width:320px;margin-top:8px;border-radius:6px}
.controls{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<header><h1>Purple Board</h1></header>
<div class="container">

  <div class="card">
    <strong>Boards</strong>
    <div id="boards" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <strong>Post</strong>
    <label class="small">Board</label>
    <select id="boardSelect"></select>
    <label class="small">Name (optional)</label>
    <input id="name" placeholder="Name (optional)">
    <label class="small">Text</label>
    <textarea id="text" rows="4"></textarea>
    <label class="small">Attach image</label>
    <input id="file" type="file" accept="image/*">
    <div class="controls" style="margin-top:8px">
      <button id="postBtn">Post</button>
      <button id="refreshBtn" class="small">Refresh</button>
      <div id="postStatus" class="small"></div>
    </div>
  </div>

  <div class="card">
    <strong>Threads (shared)</strong>
    <div id="threads" class="thread-list" style="margin-top:8px">Loading…</div>
  </div>

</div>

<script>
/* ---------- CONFIG (REPLACE) ---------- */
const WORKER_BASE = 'https://pbordworker.dassouraasish.workers.dev'; // your worker URL
const BOARDS = {
  art: { webhook: "https://discord.com/api/webhooks/1456573325148164128/UlQfAb8WE1hWw_uBCs01QPuLjuBg4HAjKAyifGjs0-YDqjIB75Ee1RMvBX0EmoXwE8Xi", channel: "1456573325148164128" },
  tech: { webhook: "https://discord.com/api/webhooks/1456573404521173041/pxVoHmjnnYTjwEH1EDmf6uMvVbQD3vPogizcyt_5T16AaNUStyw3XyWEniiCvRegprAg", channel: "1456573404521173041" },
  random: { webhook: "https://discord.com/api/webhooks/1456573475815690395/lb5_p1w6MXf852xPI67v9BPRqSicH_gvpf1C2ki2AmKyb7xL0nUHCrBhsBRrxzSrD26P", channel: "1456573475815690395" }
};
/* -------------------------------------- */

const $ = id => document.getElementById(id);
const boardSelect = $('boardSelect');
const threadsEl = $('threads');
const postBtn = $('postBtn');
const refreshBtn = $('refreshBtn');

function initUI(){
  boardSelect.innerHTML = '';
  const boardsDiv = $('boards');
  boardsDiv.innerHTML = '';
  for (const k in BOARDS){
    const b = BOARDS[k];
    const btn = document.createElement('button');
    btn.textContent = '/'+k+'/';
    btn.style.marginRight='8px';
    btn.onclick = ()=> selectBoard(k);
    boardsDiv.appendChild(btn);

    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = '/'+k+'/';
    boardSelect.appendChild(opt);
  }
  postBtn.addEventListener('click', onPost);
  refreshBtn.addEventListener('click', loadThreads);
  selectBoard(Object.keys(BOARDS)[0]);
  loadThreads();
}

let currentBoardKey = null;
function selectBoard(key){
  currentBoardKey = key;
  loadThreads();
}

async function onPost(){
  $('postStatus').textContent = '';
  if(!currentBoardKey) { $('postStatus').textContent = 'Choose a board'; return; }
  const b = BOARDS[currentBoardKey];
  const name = $('name').value.trim();
  const text = $('text').value.trim();
  const file = $('file').files[0];
  if(!text && !file){ $('postStatus').textContent = 'Write something or attach an image'; return; }
  const fd = new FormData();
  fd.append('content', (name ? name + '\n' : '') + text);
  if(file) fd.append('file', file);
  try{
    const url = b.webhook.includes('?') ? b.webhook + '&wait=true' : b.webhook + '?wait=true';
    const r = await fetch(url, { method: 'POST', body: fd });
    if(!r.ok) throw new Error('post failed: '+r.status);
    const j = await r.json();
    $('postStatus').textContent = 'Posted ✓';
    $('text').value = ''; $('file').value = '';
    // optimistic reload
    setTimeout(loadThreads, 1200);
  }catch(e){
    console.error(e);
    $('postStatus').textContent = 'Post failed (console)';
  }
}

function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

function formatContent(text){
  if(!text) return '';
  let t = escapeHtml(text);
  // greentext
  t = t.replace(/^&gt;(.+)$/gm, (m,p)=>`<div style="color:#7cffb2">&gt;${escapeHtml(p)}</div>`);
  // >>id
  t = t.replace(/&gt;&gt;(\d+)/g, '<span style="background:rgba(255,255,255,0.02);padding:4px;border-radius:4px">&gt;&gt;$1</span>');
  // linkify
  t = t.replace(/(https?:\/\/[^\s]+)/g, m => `<a href="${m}" target="_blank" style="color:#a86ff9">${m}</a>`);
  return t.replace(/\n/g,'<br>');
}

// Group messages into threads by scanning for >>id references.
// If message contains >><id> and that <id> exists -> treat as reply; else treat as OP
function groupToThreads(msgs){
  // msgs: array newest-first from worker
  const map = new Map(); // id -> message
  msgs.forEach(m => map.set(m.id, m));
  const threads = new Map(); // opId -> { op, replies: [] }
  // start by assuming every message is an OP
  msgs.forEach(m => {
    threads.set(m.id, { op: m, replies: [] });
  });
  // now classify replies
  msgs.forEach(m => {
    const match = m.content && m.content.match(/>>(\d+)/);
    if(match){
      const refId = match[1];
      if(map.has(refId)){
        // it's a reply to refId
        const t = threads.get(refId) || { op: map.get(refId), replies: [] };
        t.replies.push(m);
        threads.set(refId, t);
        // remove m from top-level if present
        if(threads.has(m.id)) threads.delete(m.id);
      }
    }
  });
  // return threads as array ordered by op timestamp (newest first)
  return Array.from(threads.values()).sort((a,b)=> new Date(b.op.timestamp) - new Date(a.op.timestamp));
}

async function loadThreads(){
  threadsEl.innerHTML = 'Loading…';
  if(!WORKER_BASE || WORKER_BASE.includes('PASTE')) { threadsEl.innerHTML = 'Worker not configured. Set WORKER_BASE.'; return; }
  const b = BOARDS[currentBoardKey];
  if(!b || !b.channel){ threadsEl.innerHTML = 'Board missing channel id for reading.'; return; }
  try{
    const res = await fetch(`${WORKER_BASE.replace(/\/$/,'')}/messages?channel_id=${b.channel}&limit=80`);
    if(!res.ok) throw new Error('fetch failed: '+res.status);
    const data = await res.json(); // array newest-first
    // group into threads
    const threads = groupToThreads(data);
    renderThreads(threads);
  }catch(e){
    console.error(e);
    threadsEl.innerHTML = 'Failed to load messages (console)';
  }
}

function renderThreads(threads){
  threadsEl.innerHTML = '';
  if(!threads.length){ threadsEl.innerHTML = '<div class="small">No threads found.</div>'; return; }
  threads.forEach(t => {
    const op = t.op;
    const d = document.createElement('div'); d.className='post';
    d.innerHTML = `<div class="small"><strong>${escapeHtml(op.author_name)}</strong> • ${new Date(op.timestamp).toLocaleString()}</div><div style="margin-top:6px">${formatContent(op.content)}</div>`;
    if(op.attachments && op.attachments.length){
      const img = document.createElement('img'); img.src = op.attachments[0].url; img.className='thumb'; d.appendChild(img);
    }
    // replies
    if(t.replies && t.replies.length){
      const replyWrap = document.createElement('div'); replyWrap.style.marginTop='8px';
      t.replies.slice(0,6).forEach(r => {
        const rr = document.createElement('div'); rr.className='post';
        rr.style.marginTop='6px';
        rr.innerHTML = `<div class="small">${escapeHtml(r.author_name)} • ${new Date(r.timestamp).toLocaleString()}</div><div style="margin-top:6px">${formatContent(r.content)}</div>`;
        if(r.attachments && r.attachments[0]){ const im = document.createElement('img'); im.src = r.attachments[0].url; im.style.maxWidth='220px'; im.style.marginTop='6px'; rr.appendChild(im); }
        replyWrap.appendChild(rr);
      });
      d.appendChild(replyWrap);
    }
    threadsEl.appendChild(d);
  });
}

initUI();
</script>
</body>
</html>
